# 货物分配与货物积压

Cargo distribution（货物分配）是 OpenTTD 独有的功能。

在原版 TTD 中，玩家需要手动管理货物流。
这种设置对于普通货物来说似乎合理，但这种机制却不适用于乘客与邮件：
乘客与邮件会在到达下一个站点时立即结算。

这里是一个来自 [OpenTTD 百科](https://wiki.openttd.org/en/Manual/Passenger%20and%20cargo%20distribution)的例子：

> - 假设有一列火车往返于甲镇和乙镇之间
> - 甲乙两镇都有一套公交网络连接城镇与火车站
>
> 你可能希望乘客可以从甲镇的任何一座车站前往乙镇的任何一座车站。
> 在 TTD 中，可以让甲地公交从各个公交站接载乘客，然后在火车站转车。
> 乙镇公交则在火车站与公交站之间来回单点穿梭，将乘客分配到公交站。
>
> - 甲镇公交将所有乘客集中在火车站
> - 乙镇每辆车都使用“联运和空车离开”指令
>
> 与此同时：
>
> - 这种方案不允许乘客从乙镇前往甲镇
> - 这种方案不允许乘客前往任何一个火车站或在一个镇内的公交站点之间换乘
>
> 理论上来说可以通过添加车辆并修改线路的方式解决这些问题，
> 但是车站和车辆越多，网络就越复杂。

在现实生活中，乘客在旅途中可能会经过多个站点，也可能在中途转车、使用各种类型的交通工具。
“货物分配”实现了这一机制。

```{caution}
旅客与邮件实际上是特殊的货物。为了简便起见，以下所称的“货物”均包括旅客与邮件。
```

```{warning}
“货物分配”与“货物目的地”完全不同：前者指代“cargo distribution”，或“carogdist”，
后者则是“cargo destination”，即“cargodest”。“货物目的地”从来就没有在游戏里出现过，
部分玩家误读文章导致线路规划完全错误。
```

```{figure} media/image.png
:align: center
:width: 500px

启用货物分配时的车站
```

## 手动、对称、不对称

可以在游戏设置中更改货物分配模式。
货物分配模式有三种：

- 手动
- 对称
- 不对称

“手动”即“手动管理货物流”，与 TTD 中的分配方式没有区别。
使用“对称”和“不对称”则会自动启用“货物分配”。

不管使用“对称”还是“不对称”，货物都会自行被分配到一个目的地，
并且会使用一切可行的交通工具前往目的地。这两者的区别在于，
“对称”会在两站之间设置对称的货物流，如：在一个经济周期内，甲站向乙站发送 100 位乘客，
乙站也会向甲站发送 100 位乘客。而“不对称”则没有这个限制。甲站向乙站发送 100 位乘客，
乙站可以不向甲站发送任何乘客。

### 距离与分流

在游戏设置中可以调整“距离对分配的影响”与“路径最大饱和度”。
前者确定车站间距离对货物分配的影响：

> 有甲、乙、丙三车站。\
> 距离关系为 甲 — 10km — 乙 — 10km — 丙。\
> 在“距离对分配的影响”不为 0 时，货物发送遵守以下规则：
>
> - 甲站发送货物时，系统会优先将货物分配到较近的站，即乙站。
> - 丙站发送货物时，系统会优先将货物分配到较近的站，即乙站。
> - 乙站发送货物时，系统会优先将货物分配到较近的站，即甲站或丙站。
>
> “距离对分配的影响”越小，远处的车站和近处的车站所分配到的货物数量越接近。

后者决定路径最大饱和度。若两地之间有多条货物路径，系统将会在其中一条的容量不足时
将货物分配至另一条货物路径上。“最大饱和度”即调整容量阈值。

## 维持平衡与客货流

我们都做过这样一道题目：

> 泳池管理员每小时放水 $10$ 升，同时泳池每小时进水 $20$ 升。\
> 问：一个 $30000$ 升的游泳池需要多久灌满？

OpenTTD 的车站很好理解：城镇中的车站每隔一段时间固定“产出”一些乘客，
乘客随后通过交通工具运走。

在游玩的过程中经常出现这种情况：某玩家的公交车站或者火车站积压了大量乘客。
这名玩家随后添加了大量载具，但是载具到头来利润却减少，甚至直接亏损。
这是因为载具的总和运力已经大大超过车站的产率。

在刚才的游泳池例子里，这就好比管理员每小时放水 $10000$ 升，而进水量不变。
理想情况下，总和运力应当等于产率。
在实际操作中只需要保证运力稍稍超过产率就可以，
在游泳池的例子里可以理解为每小时放水 $21$ 升。
即使现在有积压的乘客货物，经过的时间足够长，积压的状况就会大大缓解。

> 泳池管理员每小时放水 $21$ 升，同时泳池每小时进水 $20$ 升。\
> 问：一个 $30000$ 升的游泳池需要多久灌满？
>
> 答：永远不会灌满！

### 客货流

前面提到了“产率”与“运力”。车站的产率可以直接看车站菜单确定
（不考虑转运站等较为复杂的情况）。评估运力，最简单的方式是使用“客货流”工具。

在开启客货流后，游戏地图上会叠加一层“链接图”（linkgraph）。链接图展示某两站之间货物运输的状况。
<!-- markdownlint-disable -->
**如果运力不足，链接的颜色为<span style="color: red">红色</span>或<span style="color: yellow; background-color: grey;">黄色</span>，
运力与产率平衡为<span style="color: darkgreen">深绿色</span>，
而运力大大超过产率为<span style="color: lightgreen; background-color: grey;">浅绿色</span>或<span style="color: white; background-color: grey">白色</span>**
<!-- markdownlint-enable -->

```{note}
在第一次开启客货流时，地图上可能不会显示任何链接。这是因为需要在客货流菜单中指明
显示的货物类别与公司。选中了某家公司与指定的货物才会在地图中显示这些公司对应货物运输的链接。
```

## 车站菜单

### 实时与已计划

在车站内可以显示**实时**（等候中）货物状态与**预计**（已计划）货物状态。

> 实时：显示车站目前有多少货物，以及货物去向、来源、经停地。\
> 预计：显示车站预计发出、接受多少货物；显示经过车站的货物。

长远地看，在保证运力大于产率时，“实时”意义不大：
运力大于产率，产出的所有货物都可以被运走，滞留的货物数应当为 0。

### 货物分配目的地

在启用货物分配之后可以在车站菜单内查看货物分配情况。

如前文所属，开启货物分配后，货物会有**目的地**与**始发地**。
车站菜单在两者的基础上添加了“途径地”。

可以在车站菜单内查看货物目的地、始发地、途经地。
